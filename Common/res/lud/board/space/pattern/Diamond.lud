(define "AllVerticesOfCell"
    (sites Incident Vertex of:Cell at:(site))
)

(define "SquareFilled"
    (=
        4
        (count Sites in:(forEach ("AllVerticesOfCell") if:(is Mover (who at:(site)))))
    )
)

(define "IsATriangle"
    (= 3 (count Sites in:(sites Incident Vertex of:Cell at:(site))))
)

(define "TwoFriendPieces"
    (= 2 (count Sites in:(forEach (sites Incident Vertex of:Cell at:(site)) if:(is Mover (who at:(site))))))
)

(define "OneEnemyPiece"
    (= 1 (count Sites in:(forEach (sites Incident Vertex of:Cell at:(site)) if:(is Next (who at:(site))))))
)

(define "ReplaceEnemyPieceByNeutral"
    (and
        (remove (site))
        (add (piece (id "Disc" Neutral)) (to (site)))
    )
)

(define "TrianglesWithCaptures"
    (forEach (sites Incident Cell of:Vertex at:(last To))
        if:(and {
            ("IsATriangle")
            ("TwoFriendPieces")
            ("OneEnemyPiece")
        })
    )
)

//------------------------------------------------------------------------------

(game "Diamond"
    (players 2)
    (equipment {
        (board
            (rotate 90 (tiling T33434 3))
            use:Vertex
        )
        (piece "Disc" Each
            (move Step (to if:(is Empty (to)))
                (then
                    (if (= 1 (count Sites in:("TrianglesWithCaptures")))
                        (forEach Site (sites Incident Cell of:Vertex at:(last To))
                            (if (and {
                                    ("IsATriangle")
                                    ("TwoFriendPieces")
                                    ("OneEnemyPiece")
                                })
                                (and
                                    (forEach Site
                                        (forEach (sites Incident Vertex of:Cell at:(site)) if:(is Next (who at:(site))))
                                        ("ReplaceEnemyPieceByNeutral")
                                    )
                                    (set Counter)
                                )
                            )
                        )
                    )
                )
            )
        )
        (piece "Disc" Neutral)
        (hand Each)
        (regions P1 { (sites Side W) (sites Side E) } )
        (regions P2 { (sites Side N) (sites Side S) } )
    })
    (rules
        (meta (swap))

        (start (place "Disc" "Hand" count:12))

        phases:{
        (phase "Placement"
            (play
                (move
                    (from (handSite Mover))
                    (to (sites Empty))
                    (then
                        (and
                            (forEach Site (sites Incident Cell of:Vertex at:(last To))
                                (if ("SquareFilled") (trigger "Win" Mover))
                            )
                            (set Counter)
                        )
                    )
                )
            )
            (nextPhase Mover (is Empty (handSite Mover)) "Movement")
        )
        (phase "Movement"
            (play
                (or
                    (forEach Piece)
                    (move Remove (sites Occupied by:Neutral))
                )
            )
        )
        }
        (end {
            (if (is Triggered "Win" Mover)
                (result Mover Win)
            )
            (if (or (no Moves Mover) (= (counter) 49)) (result Mover Draw))
        })
    )
)

//------------------------------------------------------------------------------

(metadata

    (info
        {
        }
    )

    (graphics {
        (player Colour Neutral (colour Red))
        (player Colour P1 (colour Black))
        (player Colour P2 (colour White))
        (board Background image:"square.svg" fillColour:(colour 218 164 50) edgeColour:(colour Black) scale:1.3)
        (board Colour InnerEdges (colour Black))
        (board Colour OuterEdges (colour Black))
        (board Colour InnerVertices (colour Hidden))
        (board Colour OuterVertices (colour Hidden))
        (show Edges Diagonal (colour Hidden))
    })
)
