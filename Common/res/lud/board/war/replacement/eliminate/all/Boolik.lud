(define "ThrowValue" (mapEntry "Throw" (count Pips)))

(define "EntryPoint" (mapEntry "Entry" (mover)))

(define "SiteToMoveOnTrack" (trackSite Move #1 #2 steps:#3))

(define "NoPieceOnBoard" (< (count Pieces Mover in:(sites Board)) 1))

(define "SetCapturePiece"
    (set State #1 #2 2)
)

(define "SetCapturingPiece"
    (set State #1 #2 1)
)

(define "UnsetCapturingPiece" (set State #1 #2 0))

(define "UnsetCapturingPieces"
    (forEach Level (last From) FromTop
        (if (is Friend (who at:(last From) level:(level)))
            ("UnsetCapturingPiece" at:(last From) level:(level))
        )
    )
)

(define "AtLeastAnEnemyPieceThere"
    (is In #1 (sites Occupied by:Enemy top:False))
)

(define "CaptureMove"
    (forEach Level (last To) FromTop
        (and
            (if (is Enemy (who at:(last To) level:(level)))
                ("SetCapturePiece" at:(last To) level:(level))
            )
            (if (is Friend (who at:(last To) level:(level)))
                ("SetCapturingPiece" at:(last To) level:(level))
            )
        )
    )
)

(define "CapturingPiece" (= 1 #1))

(define "CapturedPiece" (= 2 #1))

(define "FreePiece" (= 0 #1))

(define "EnterAPiece"
    (move
        (from (handSite Mover))
        (to ("SiteToMoveOnTrack" from:("EntryPoint" (mover)) "Track" (- "ThrowValue" 1) ))
    )
)

(define "RemoveCapturedPieces"
    (forEach Level (last From) FromTop
        (if ("CapturedPiece" (state at:(last From) level:(level)))
            (remove (last From) level:(level))
        )
    )
)
(define "RebirthCapturingPiece"
    (add
        (piece (id "Stick" Mover))
        (to (handSite Mover))
    )
)

(define "CapturedPiecesFollowCapturingPiece"
    (forEach Level (last From) FromTop
        (if ("CapturedPiece" (state at:(last From) level:(level)))
            (fromTo
                (from (last From) level:(level))
                (to (last To))
            )
        )
    )
)

//------------------------------------------------------------------------------

(game "Boolik"
    (players <Player:num>)
    (equipment {
        (board
            (rectangle 1 15)
            <Player:tracks>
            use:Edge
        )
        (piece "Stick" Each
            (or
                (if ("FreePiece" (state at:(from) level:(level)))
                    (move
                        (from (from) level:(level))
                        (to
                            ("SiteToMoveOnTrack" from:(from) "Track" ("ThrowValue"))
                        )
                        (then
                            (if ("AtLeastAnEnemyPieceThere" (last To))
                                ("CaptureMove")
                            )
                        )
                    )
                )
                (if ("CapturingPiece" (state at:(from) level:(level)))
                    (if (!= Off ("SiteToMoveOnTrack" from:(from) "CaptureTrack" ("ThrowValue")))
                        (move
                            (from (from) level:(level))
                            (to
                                ("SiteToMoveOnTrack" from:(from) "CaptureTrack" ("ThrowValue"))
                            )
                            (then
                                (and
                                    ("CapturedPiecesFollowCapturingPiece")
                                    ("UnsetCapturingPieces")
                                )
                            )
                        )
                        (move Remove (from) level:(level)
                            (then
                                (and {
                                    ("UnsetCapturingPieces")
                                    ("RemoveCapturedPieces")
                                    ("RebirthCapturingPiece")
                                })
                            )
                        )
                    )
                )
            )
        )
        (regions "AllSites" (sites Board Vertex))
        (map "Throw" {(pair 0 5) (pair 1 1) (pair 2 2) (pair 3 3) (pair 4 4)})
        (map "Entry" {
            (pair 1 0) (pair 2 13) (pair 3 0) (pair 4 13)
            (pair 5 0) (pair 6 13) (pair 7 0) (pair 8 13)
            (pair 9 0) (pair 10 13) (pair 11 0) (pair 12 13)
            (pair 13 0) (pair 14 13) (pair 15 0) (pair 16 13)
        })
        (dice d:2 from:0 num:4)
        (hand Each)
    })
    (rules
        (start {
            <Player:teams>
        })
        (play
            (do (roll)
                next:(or {
                    (if (and ("NoPieceOnBoard") (not (is Empty (handSite Mover))))
                        ("EnterAPiece")
                    )
                    (forEach Piece)
                })
                (then
                    (if (and (not (no Pieces Mover)) (not ("SameTurn")))
                        (moveAgain)
                    )
                )
            )
        )

        (end  (if (no Pieces Enemy) (result TeamMover Win)))
    )
)

//------------------------------------------------------------------------------

(option "Players" <Player> args:{ <num> <teams> <tracks>}
    {
    (item "2" <2>
        <
        (set Team 1 {P1})
        (set Team 2 {P2})
        (place Stack "Stick1" (handSite P1) count:5)
        (place Stack "Stick2" (handSite P2) count:5)
        >
        <
        {
        (track "Track1" {0..13} loop:True P1)
        (track "Track2" {13..0} loop:True P2)
        (track "CaptureTrack1" {13..0} P1 directed:True)
        (track "CaptureTrack2" {0..13} P2 directed:True)
        }
        >
    "The game has 2 players.")

    (item "4" <4>
        <
        (set Team 1 {P1 P3})
        (set Team 2 {P2 P4})
        (place Stack "Stick1" (handSite P1) count:5)
        (place Stack "Stick2" (handSite P2) count:5)
        (place Stack "Stick3" (handSite P3) count:5)
        (place Stack "Stick4" (handSite P4) count:5)
        >
        <
        {
        (track "Track1" {0..13} loop:True P1)
        (track "Track2" {13..0} loop:True P2)
        (track "CaptureTrack1" {13..0} P1 directed:True)
        (track "CaptureTrack2" {0..13} P2 directed:True)
        (track "Track3" {0..13} loop:True P3)
        (track "Track4" {13..0} loop:True P4)
        (track "CaptureTrack3" {13..0} P3 directed:True)
        (track "CaptureTrack4" {0..13} P4 directed:True)
        }
        >
    "The game has 4 players.")

    (item "6" <6>
        <
        (set Team 1 {P1 P3 P5})
        (set Team 2 {P2 P4 P6})
        (place Stack "Stick1" (handSite P1) count:5)
        (place Stack "Stick2" (handSite P2) count:5)
        (place Stack "Stick3" (handSite P3) count:5)
        (place Stack "Stick4" (handSite P4) count:5)
        (place Stack "Stick5" (handSite P5) count:5)
        (place Stack "Stick6" (handSite P6) count:5)
        >
        <
        {
        (track "Track1" {0..13} loop:True P1)
        (track "Track2" {13..0} loop:True P2)
        (track "CaptureTrack1" {13..0} P1 directed:True)
        (track "CaptureTrack2" {0..13} P2 directed:True)
        (track "Track3" {0..13} loop:True P3)
        (track "Track4" {13..0} loop:True P4)
        (track "CaptureTrack3" {13..0} P3 directed:True)
        (track "CaptureTrack4" {0..13} P4 directed:True)
        (track "Track5" {0..13} loop:True P5)
        (track "Track6" {13..0} loop:True P6)
        (track "CaptureTrack5" {13..0} P5 directed:True)
        (track "CaptureTrack6" {0..13} P6 directed:True)
        }
        >
    "The game has 6 players.")*

    (item "8" <8>
        <
        (set Team 1 {P1 P3 P5 P7})
        (set Team 2 {P2 P4 P6 P8})
        (place Stack "Stick1" (handSite P1) count:5)
        (place Stack "Stick2" (handSite P2) count:5)
        (place Stack "Stick3" (handSite P3) count:5)
        (place Stack "Stick4" (handSite P4) count:5)
        (place Stack "Stick5" (handSite P5) count:5)
        (place Stack "Stick6" (handSite P6) count:5)
        (place Stack "Stick7" (handSite P7) count:5)
        (place Stack "Stick8" (handSite P8) count:5)
        >
        <
        {
        (track "Track1" {0..13} loop:True P1)
        (track "Track2" {13..0} loop:True P2)
        (track "CaptureTrack1" {13..0} P1 directed:True)
        (track "CaptureTrack2" {0..13} P2 directed:True)
        (track "Track3" {0..13} loop:True P3)
        (track "Track4" {13..0} loop:True P4)
        (track "CaptureTrack3" {13..0} P3 directed:True)
        (track "CaptureTrack4" {0..13} P4 directed:True)
        (track "Track5" {0..13} loop:True P5)
        (track "Track6" {13..0} loop:True P6)
        (track "CaptureTrack5" {13..0} P5 directed:True)
        (track "CaptureTrack6" {0..13} P6 directed:True)
        (track "Track7" {0..13} loop:True P7)
        (track "Track8" {13..0} loop:True P8)
        (track "CaptureTrack7" {13..0} P7 directed:True)
        (track "CaptureTrack8" {0..13} P8 directed:True)
        }
        >
    "The game has 8 players.")

    (item "10" <10>
        <
        (set Team 1 {P1 P3 P5 P7 P9})
        (set Team 2 {P2 P4 P6 P8 P10})
        (place Stack "Stick1" (handSite P1) count:5)
        (place Stack "Stick2" (handSite P2) count:5)
        (place Stack "Stick3" (handSite P3) count:5)
        (place Stack "Stick4" (handSite P4) count:5)
        (place Stack "Stick5" (handSite P5) count:5)
        (place Stack "Stick6" (handSite P6) count:5)
        (place Stack "Stick7" (handSite P7) count:5)
        (place Stack "Stick8" (handSite P8) count:5)
        (place Stack "Stick9" (handSite P9) count:5)
        (place Stack "Stick10" (handSite P10) count:5)
        >
        <
        {
        (track "Track1" {0..13} loop:True P1)
        (track "Track2" {13..0} loop:True P2)
        (track "CaptureTrack1" {13..0} P1 directed:True)
        (track "CaptureTrack2" {0..13} P2 directed:True)
        (track "Track3" {0..13} loop:True P3)
        (track "Track4" {13..0} loop:True P4)
        (track "CaptureTrack3" {13..0} P3 directed:True)
        (track "CaptureTrack4" {0..13} P4 directed:True)
        (track "Track5" {0..13} loop:True P5)
        (track "Track6" {13..0} loop:True P6)
        (track "CaptureTrack5" {13..0} P5 directed:True)
        (track "CaptureTrack6" {0..13} P6 directed:True)
        (track "Track7" {0..13} loop:True P7)
        (track "Track8" {13..0} loop:True P8)
        (track "CaptureTrack7" {13..0} P7 directed:True)
        (track "CaptureTrack8" {0..13} P8 directed:True)
        (track "Track9" {0..13} loop:True P9)
        (track "Track10" {13..0} loop:True P10)
        (track "CaptureTrack9" {13..0} P9 directed:True)
        (track "CaptureTrack10" {0..13} P10 directed:True)
        }
        >
    "The game has 10 players.")

    (item "12" <12>
        <
        (set Team 1 {P1 P3 P5 P7 P9 P11})
        (set Team 2 {P2 P4 P6 P8 P10 P12})
        (place Stack "Stick1" (handSite P1) count:5)
        (place Stack "Stick2" (handSite P2) count:5)
        (place Stack "Stick3" (handSite P3) count:5)
        (place Stack "Stick4" (handSite P4) count:5)
        (place Stack "Stick5" (handSite P5) count:5)
        (place Stack "Stick6" (handSite P6) count:5)
        (place Stack "Stick7" (handSite P7) count:5)
        (place Stack "Stick8" (handSite P8) count:5)
        (place Stack "Stick9" (handSite P9) count:5)
        (place Stack "Stick10" (handSite P10) count:5)
        (place Stack "Stick11" (handSite P11) count:5)
        (place Stack "Stick12" (handSite P12) count:5)
        >
        <
        {
        (track "Track1" {0..13} loop:True P1)
        (track "Track2" {13..0} loop:True P2)
        (track "CaptureTrack1" {13..0} P1 directed:True)
        (track "CaptureTrack2" {0..13} P2 directed:True)
        (track "Track3" {0..13} loop:True P3)
        (track "Track4" {13..0} loop:True P4)
        (track "CaptureTrack3" {13..0} P3 directed:True)
        (track "CaptureTrack4" {0..13} P4 directed:True)
        (track "Track5" {0..13} loop:True P5)
        (track "Track6" {13..0} loop:True P6)
        (track "CaptureTrack5" {13..0} P5 directed:True)
        (track "CaptureTrack6" {0..13} P6 directed:True)
        (track "Track7" {0..13} loop:True P7)
        (track "Track8" {13..0} loop:True P8)
        (track "CaptureTrack7" {13..0} P7 directed:True)
        (track "CaptureTrack8" {0..13} P8 directed:True)
        (track "Track9" {0..13} loop:True P9)
        (track "Track10" {13..0} loop:True P10)
        (track "CaptureTrack9" {13..0} P9 directed:True)
        (track "CaptureTrack10" {0..13} P10 directed:True)
        (track "Track11" {0..13} loop:True P11)
        (track "Track12" {13..0} loop:True P12)
        (track "CaptureTrack11" {13..0} P11 directed:True)
        (track "CaptureTrack12" {0..13} P12 directed:True)
        }
        >
    "The game has 12 players.")

    (item "14" <14>
        <
        (set Team 1 {P1 P3 P5 P7 P9 P11 P13})
        (set Team 2 {P2 P4 P6 P8 P10 P12 P14})
        (place Stack "Stick1" (handSite P1) count:5)
        (place Stack "Stick2" (handSite P2) count:5)
        (place Stack "Stick3" (handSite P3) count:5)
        (place Stack "Stick4" (handSite P4) count:5)
        (place Stack "Stick5" (handSite P5) count:5)
        (place Stack "Stick6" (handSite P6) count:5)
        (place Stack "Stick7" (handSite P7) count:5)
        (place Stack "Stick8" (handSite P8) count:5)
        (place Stack "Stick9" (handSite P9) count:5)
        (place Stack "Stick10" (handSite P10) count:5)
        (place Stack "Stick11" (handSite P11) count:5)
        (place Stack "Stick12" (handSite P12) count:5)
        (place Stack "Stick13" (handSite P13) count:5)
        (place Stack "Stick14" (handSite P14) count:5)
        >
        <
        {
        (track "Track1" {0..13} loop:True P1)
        (track "Track2" {13..0} loop:True P2)
        (track "CaptureTrack1" {13..0} P1 directed:True)
        (track "CaptureTrack2" {0..13} P2 directed:True)
        (track "Track3" {0..13} loop:True P3)
        (track "Track4" {13..0} loop:True P4)
        (track "CaptureTrack3" {13..0} P3 directed:True)
        (track "CaptureTrack4" {0..13} P4 directed:True)
        (track "Track5" {0..13} loop:True P5)
        (track "Track6" {13..0} loop:True P6)
        (track "CaptureTrack5" {13..0} P5 directed:True)
        (track "CaptureTrack6" {0..13} P6 directed:True)
        (track "Track7" {0..13} loop:True P7)
        (track "Track8" {13..0} loop:True P8)
        (track "CaptureTrack7" {13..0} P7 directed:True)
        (track "CaptureTrack8" {0..13} P8 directed:True)
        (track "Track9" {0..13} loop:True P9)
        (track "Track10" {13..0} loop:True P10)
        (track "CaptureTrack9" {13..0} P9 directed:True)
        (track "CaptureTrack10" {0..13} P10 directed:True)
        (track "Track11" {0..13} loop:True P11)
        (track "Track12" {13..0} loop:True P12)
        (track "CaptureTrack11" {13..0} P11 directed:True)
        (track "CaptureTrack12" {0..13} P12 directed:True)
        (track "Track13" {0..13} loop:True P13)
        (track "Track14" {13..0} loop:True P14)
        (track "CaptureTrack13" {13..0} P13 directed:True)
        (track "CaptureTrack14" {0..13} P14 directed:True)
        }
        >
    "The game has 14 players.")

    (item "16" <16>
        <
        (set Team 1 {P1 P3 P5 P7 P9 P11 P13 P15})
        (set Team 2 {P2 P4 P6 P8 P10 P12 P14 P16})
        (place Stack "Stick1" (handSite P1) count:5)
        (place Stack "Stick2" (handSite P2) count:5)
        (place Stack "Stick3" (handSite P3) count:5)
        (place Stack "Stick4" (handSite P4) count:5)
        (place Stack "Stick5" (handSite P5) count:5)
        (place Stack "Stick6" (handSite P6) count:5)
        (place Stack "Stick7" (handSite P7) count:5)
        (place Stack "Stick8" (handSite P8) count:5)
        (place Stack "Stick9" (handSite P9) count:5)
        (place Stack "Stick10" (handSite P10) count:5)
        (place Stack "Stick11" (handSite P11) count:5)
        (place Stack "Stick12" (handSite P12) count:5)
        (place Stack "Stick13" (handSite P13) count:5)
        (place Stack "Stick14" (handSite P14) count:5)
        (place Stack "Stick15" (handSite P15) count:5)
        (place Stack "Stick16" (handSite P16) count:5)
        >
        <
        {
        (track "Track1" {0..13} loop:True P1)
        (track "Track2" {13..0} loop:True P2)
        (track "CaptureTrack1" {13..0} P1 directed:True)
        (track "CaptureTrack2" {0..13} P2 directed:True)
        (track "Track3" {0..13} loop:True P3)
        (track "Track4" {13..0} loop:True P4)
        (track "CaptureTrack3" {13..0} P3 directed:True)
        (track "CaptureTrack4" {0..13} P4 directed:True)
        (track "Track5" {0..13} loop:True P5)
        (track "Track6" {13..0} loop:True P6)
        (track "CaptureTrack5" {13..0} P5 directed:True)
        (track "CaptureTrack6" {0..13} P6 directed:True)
        (track "Track7" {0..13} loop:True P7)
        (track "Track8" {13..0} loop:True P8)
        (track "CaptureTrack7" {13..0} P7 directed:True)
        (track "CaptureTrack8" {0..13} P8 directed:True)
        (track "Track9" {0..13} loop:True P9)
        (track "Track10" {13..0} loop:True P10)
        (track "CaptureTrack9" {13..0} P9 directed:True)
        (track "CaptureTrack10" {0..13} P10 directed:True)
        (track "Track11" {0..13} loop:True P11)
        (track "Track12" {13..0} loop:True P12)
        (track "CaptureTrack11" {13..0} P11 directed:True)
        (track "CaptureTrack12" {0..13} P12 directed:True)
        (track "Track13" {0..13} loop:True P13)
        (track "Track14" {13..0} loop:True P14)
        (track "CaptureTrack13" {13..0} P13 directed:True)
        (track "CaptureTrack14" {0..13} P14 directed:True)
        (track "Track15" {0..13} loop:True P15)
        (track "Track16" {13..0} loop:True P16)
        (track "CaptureTrack15" {13..0} P15 directed:True)
        (track "CaptureTrack16" {0..13} P16 directed:True)
        }
        >
    "The game has 16 players.")

})

//------------------------------------------------------------------------------

(rulesets {
    (ruleset "Ruleset/Boolik (Observed)" {
        "Players/6"
        }
        variations:{
        "Players/2" "Players/4" "Players/8" "Players/10"
        "Players/12" "Players/14" "Players/16"
        }
    )*
})

//------------------------------------------------------------------------------

(metadata

    (info
        {
        (description "Boolik is a capturing game played by the Qeqchi people of Guatemala. It is typically played on the floor of a house at night, with two teams of people. ")
        (rules "Fifteen corn kernels are placed in a line; the playing spaces are the empty spaces between the kernels. Four corn kernels used as dice, marked on one side. The value of a throw is equal to the number of marked sides that land up, except when no marked sides are up, when the value is 5. Any number of players, who play on two teams, each starting from one side of the board. Five pieces per player. Players take turns moving pieces according to the throws of the corn, with two throws per turn. When a player reaches the opposite end of the board, they move to the start and continue moving in the same direction. If a piece lands on a space occupied by an opponent's piece, the player then moves in the reverse direction, carrying the opponent's piece with it in an attempt to move past the starting point and off the board. When the player moves past the starting point and then moves off the board, the opponent's piece is captured. The player who made the capture enters their piece again on their next turn. However, if the opponent lands on a piece carrying one of their pieces away, they then start carrying both of those pieces back to their starting point, freeing the captured piece and capturing the other player's piece. Players belonging to the same team may land on the same spot, but both are taken back to start if the opponent lands on them. Players cannot enter more than one of their pieces on the board at one time. The first team to capture all of the opposing team's pieces wins.")
        (source "Culin 1907: 141-143.")
        (version "1.3.0")
        (classification "board/war/replacement/eliminate/all")
        (credit "Eric Piette")
        (origin  "This game was played in Guatemala, around 1899.")
        }
    )

    (graphics {
        (piece Scale "Stick" 0.5)
        (show Edges (colour Hidden))
        (show Symbol "corn" "AllSites" Vertex fillColour:(colour Yellow) edgeColour:(colour Black) scale:0.5)
        (piece Foreground "Die" state:1 image:"star" fillColour:(colour White) scale:0.2)
        (stackType 0 Ground)
        (stackType 1 Count)
        (stackType 2 Count)
        (stackType 3 Count)
        (stackType 4 Count)
        (stackType 5 Count)
        (stackType 6 Count)
        (stackType 7 Count)
        (stackType 8 Count)
        (stackType 9 Count)
        (stackType 10 Count)
        (stackType 11 Count)
        (stackType 12 Count)
        (stackType 13 Count)
        (stackType 14 Count)
        (stackType 15 Count)
        (stackType 16 Count)
        (piece Scale "Stick" 0.5)
    })

)
